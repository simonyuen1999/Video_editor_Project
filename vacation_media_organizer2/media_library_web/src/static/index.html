<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Library - Vacation Photos & Videos</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 3fr 2fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .panel:hover {
            transform: translateY(-5px);
        }

        .panel h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.5rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        #map {
            height: 400px;
            border-radius: 10px;
            border: 2px solid #ddd;
        }

        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #555;
        }

        .filter-group input, .filter-group select {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .filter-group input:focus, .filter-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-card .number {
            font-size: 1.5rem;
            font-weight: bold;
            display: block;
        }

        .stat-card .label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            max-height: 600px;
            overflow-y: auto;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .media-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }

        .media-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .media-card img, .media-card video {
            width: 100%;
            height: 150px;
            object-fit: cover;
            background: #f0f0f0;
            display: block;
        }

        .media-card img[src=""], .media-card video[src=""] {
            background: linear-gradient(45deg, #f0f0f0 25%, transparent 25%),
                        linear-gradient(-45deg, #f0f0f0 25%, transparent 25%),
                        linear-gradient(45deg, transparent 75%, #f0f0f0 75%),
                        linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }

        .media-card img:not([src]), .media-card video:not([src]) {
            opacity: 0.5;
        }

        .media-card-content {
            padding: 15px;
        }

        .media-card h3 {
            font-size: 1rem;
            margin-bottom: 8px;
            color: #333;
        }

        .media-card .meta {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 5px;
        }

        .media-card .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .tag {
            background: #667eea;
            color: white;
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 0.75rem;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
        }

        .modal-content {
            position: relative;
            margin: 5% auto;
            width: 90%;
            max-width: 800px;
            background: white;
            border-radius: 15px;
            overflow: hidden;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.3s ease;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-media {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .filters {
                grid-template-columns: 1fr;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .nav-links a:hover {
            background: rgba(255,255,255,0.3) !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì∏ Vacation Media Library</h1>
            <p>Explore your photos and videos with interactive maps and smart filtering</p>
        </div>

        <div class="nav-links" style="text-align: center; margin-bottom: 20px;">
            <a href="index.html" class="active" style="color: white; text-decoration: none; margin: 0 15px; padding: 8px 16px; border-radius: 20px; background: rgba(255,255,255,0.4); font-weight: bold;">üó∫Ô∏è Map View</a>
            <a href="daily.html" style="color: white; text-decoration: none; margin: 0 15px; padding: 8px 16px; border-radius: 20px; background: rgba(255,255,255,0.2); transition: background 0.3s ease;">üìÖ Daily View</a>
        </div>

        <div class="main-content">
            <div class="panel">
                <h2>üó∫Ô∏è Interactive Map</h2>
                <div id="map"></div>
            </div>

            <div class="panel">
                <h2>üîç Filters & Search</h2>
                <div class="filters">
                    <div class="filter-group">
                        <label for="city-filter">City</label>
                        <select id="city-filter">
                            <option value="">Select a city...</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="country-filter">Country</label>
                        <select id="country-filter">
                            <option value="">Select a country...</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="date-from">Date From</label>
                        <input type="datetime-local" id="date-from">
                    </div>
                    <div class="filter-group">
                        <label for="date-to">Date To</label>
                        <input type="datetime-local" id="date-to">
                    </div>
                    <div class="filter-group">
                        <label for="has-people">Has People</label>
                        <select id="has-people">
                            <option value="">All</option>
                            <option value="true">Yes</option>
                            <option value="false">No</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="talking">Talking Detected</label>
                        <select id="talking">
                            <option value="">All</option>
                            <option value="true">Yes</option>
                            <option value="false">No</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <button id="search-btn" onclick="searchMedia()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; margin-top: 20px;">
                            üîç Search Media
                        </button>
                        <button id="sort-toggle-btn" onclick="toggleSortOrder()" style="padding: 10px 15px; background: #fd7e14; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; margin-top: 20px; margin-left: 10px;">
                            üìÖ Oldest First
                        </button>
                    </div>
                </div>
                
                <!-- Search Results Summary -->
                <div id="search-results" style="display: none; margin: 20px 0; padding: 15px; background: #e8f4f8; border-radius: 8px; border-left: 4px solid #667eea;">
                    <div id="results-summary"></div>
                    <div style="margin-top: 10px;">
                        <button id="load-images-btn" onclick="loadImages()" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                            üì∑ Load Images
                        </button>
                        <button onclick="clearResults()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            üîÑ New Search
                        </button>
                    </div>
                </div>
                
                <div class="stats" id="stats">
                    <!-- Stats will be loaded here -->
                </div>
            </div>
        </div>

        <div class="panel">
            <h2>üì± Media Gallery</h2>
            <div id="initial-message" class="loading">
                üéØ Select date range and search criteria above, then click "Search Media" to find your photos and videos.
            </div>
            <div id="loading" class="loading" style="display: none;">Searching media...</div>
            <div id="loading-images" class="loading" style="display: none;">Loading images...</div>
            <div id="error" class="error" style="display: none;"></div>
            <div id="media-grid" class="media-grid" style="display: none;">
                <!-- Media cards will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Modal for media preview -->
    <div id="media-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Media Details</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Media details will be loaded here -->
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Helper function to format creation time
        function formatCreationTime(creationTime) {
            if (!creationTime) return 'Unknown Date';
            try {
                // Convert date format from "YYYY-MM-DD HH-MM-SS" to "YYYY-MM-DD HH:MM:SS"
                let formattedTime = creationTime;
                if (formattedTime.match && formattedTime.match(/\d{4}-\d{2}-\d{2} \d{2}-\d{2}-\d{2}/)) {
                    formattedTime = formattedTime.replace(/ (\d{2})-(\d{2})-(\d{2})/, ' $1:$2:$3');
                }
                const date = new Date(formattedTime);
                return date.toLocaleString();
            } catch (e) {
                return creationTime;
            }
        }

        // Global variables
        let map;
        let searchResults = [];
        let loadedMediaData = [];
        let markers = [];
        let currentSortOrder = 'asc';  // Default to ASC (oldest first)

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            loadStats();
            loadCities();
            loadCountries();
            setupEventListeners();
            // Don't load media automatically - wait for user search
        });

        // Initialize Leaflet map
        function initializeMap() {
            map = L.map('map').setView([40.7128, -74.0060], 2); // Default to New York
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
        }

        // Load statistics
        async function loadStats() {
            try {
                const response = await fetch('/api/media/stats');
                const stats = await response.json();
                
                const statsContainer = document.getElementById('stats');
                statsContainer.innerHTML = `
                    <div class="stat-card">
                        <span class="number">${stats.total_media}</span>
                        <span class="label">Total Media</span>
                    </div>
                    <div class="stat-card">
                        <span class="number">${stats.total_with_location}</span>
                        <span class="label">With Location</span>
                    </div>
                    <div class="stat-card">
                        <span class="number">${stats.total_with_people}</span>
                        <span class="label">With People</span>
                    </div>
                    <div class="stat-card">
                        <span class="number">${stats.total_with_talking}</span>
                        <span class="label">With Talking</span>
                    </div>
                `;

                // Set default date range values
                if (stats.date_range && stats.date_range.earliest && stats.date_range.latest) {
                    console.log('Setting default date range:', stats.date_range);
                    setDefaultDateRange(stats.date_range.earliest, stats.date_range.latest);
                } else {
                    console.log('No date range data available in stats');
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Helper function to set default date range
        function setDefaultDateRange(earliest, latest) {
            try {
                console.log('setDefaultDateRange called with:', earliest, latest);
                
                // Convert database format "YYYY-MM-DD HH-MM-SS" to datetime-local format "YYYY-MM-DDTHH:MM"
                const formatForInput = (dateStr) => {
                    console.log('Formatting date string:', dateStr);
                    if (!dateStr) return '';
                    
                    // Handle the database format with dashes in time part
                    let formatted = dateStr;
                    if (formatted.match(/\d{4}-\d{2}-\d{2} \d{2}-\d{2}-\d{2}/)) {
                        formatted = formatted.replace(/ (\d{2})-(\d{2})-(\d{2})/, ' $1:$2:$3');
                        console.log('Converted time format:', formatted);
                    }
                    
                    // Convert to datetime-local format (YYYY-MM-DDTHH:MM)
                    const date = new Date(formatted);
                    if (isNaN(date.getTime())) {
                        console.log('Invalid date:', formatted);
                        return '';
                    }
                    
                    // Format as YYYY-MM-DDTHH:MM for datetime-local input
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    
                    const result = `${year}-${month}-${day}T${hours}:${minutes}`;
                    console.log('Final formatted result:', result);
                    return result;
                };

                const dateFromInput = document.getElementById('date-from');
                const dateToInput = document.getElementById('date-to');
                
                if (dateFromInput && !dateFromInput.value) {
                    const fromValue = formatForInput(earliest);
                    dateFromInput.value = fromValue;
                    console.log('Set date-from to:', fromValue);
                }
                
                if (dateToInput && !dateToInput.value) {
                    const toValue = formatForInput(latest);
                    dateToInput.value = toValue;
                    console.log('Set date-to to:', toValue);
                }
            } catch (error) {
                console.error('Error setting default date range:', error);
            }
        }

        // Load cities into dropdown
        async function loadCities() {
            try {
                const response = await fetch('/api/media/cities');
                const cities = await response.json();
                
                const citySelect = document.getElementById('city-filter');
                citySelect.innerHTML = '<option value="">Select a city...</option>';
                
                cities.forEach(cityData => {
                    const option = document.createElement('option');
                    option.value = cityData.value;  // city_en
                    option.textContent = cityData.display;  // "city_en | city_zh"
                    citySelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading cities:', error);
            }
        }

        // Load countries into dropdown
        async function loadCountries() {
            try {
                const response = await fetch('/api/media/countries');
                const countries = await response.json();
                
                const countrySelect = document.getElementById('country-filter');
                countrySelect.innerHTML = '<option value="">Select a country...</option>';
                
                countries.forEach(countryData => {
                    const option = document.createElement('option');
                    option.value = countryData.value;  // country_en
                    option.textContent = countryData.display;  // "country_en | country_zh"
                    countrySelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading countries:', error);
            }
        }

        // Search media without loading images
        async function searchMedia() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('initial-message').style.display = 'none';
                document.getElementById('search-results').style.display = 'none';
                
                // Clear previous thumbnails from media gallery immediately
                const grid = document.getElementById('media-grid');
                grid.innerHTML = '';
                document.getElementById('media-grid').style.display = 'none';
                
                // Clear previous loaded media data
                loadedMediaData = [];
                
                const searchParams = getSearchParams();
                searchParams.order = currentSortOrder;  // Add sort order to parameters
                const queryString = new URLSearchParams(searchParams).toString();
                
                const response = await fetch(`/api/media?${queryString}`);
                searchResults = await response.json();
                
                document.getElementById('loading').style.display = 'none';
                
                // Show search results summary
                showSearchResults(searchResults);
                
            } catch (error) {
                console.error('Error searching media:', error);
                showError('Failed to search media. Please try again.');
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Toggle sort order between DESC and ASC
        function toggleSortOrder() {
            const button = document.getElementById('sort-toggle-btn');
            
            if (currentSortOrder === 'desc') {
                currentSortOrder = 'asc';
                button.textContent = 'üìÖ Oldest First';
                button.style.background = '#fd7e14';  // Orange for oldest first
            } else {
                currentSortOrder = 'desc';
                button.textContent = 'üìÖ Newest First';
                button.style.background = '#28a745';  // Green for newest first
            }
            
            // If we have search results, re-search with new order
            if (searchResults && searchResults.length > 0) {
                searchMedia();
            }
        }

        // Get search parameters from form
        function getSearchParams() {
            const city = document.getElementById('city-filter').value;
            const country = document.getElementById('country-filter').value;
            const dateFrom = document.getElementById('date-from').value;
            const dateTo = document.getElementById('date-to').value;
            const hasPeople = document.getElementById('has-people').value;
            const talking = document.getElementById('talking').value;
            
            const params = {};
            if (city) params.city = city;
            if (country) params.country = country;
            if (dateFrom) params.date_from = dateFrom;
            if (dateTo) params.date_to = dateTo;
            if (hasPeople) params.has_people = hasPeople;
            if (talking) params.talking = talking;
            
            return params;
        }

        // Show search results summary
        function showSearchResults(results) {
            const resultsDiv = document.getElementById('search-results');
            const summaryDiv = document.getElementById('results-summary');
            
            const totalCount = results.length;
            const imageCount = results.filter(media => 
                !media.file_extension || !['.mp4', '.mov', '.avi', '.mkv', '.webm'].includes(media.file_extension.toLowerCase())
            ).length;
            const videoCount = results.filter(media => 
                media.file_extension && ['.mp4', '.mov', '.avi', '.mkv', '.webm'].includes(media.file_extension.toLowerCase())
            ).length;
            const withLocationCount = results.filter(media => media.latitude && media.longitude).length;
            
            // Calculate estimated size (rough estimate)
            const avgImageSize = 2; // MB
            const avgVideoSize = 50; // MB
            const estimatedSize = (imageCount * avgImageSize + videoCount * avgVideoSize).toFixed(1);
            
            summaryDiv.innerHTML = `
                <h3>üîç Search Results Found</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin: 10px 0;">
                    <div><strong>${totalCount}</strong> files total</div>
                    <div><strong>${imageCount}</strong> images</div>
                    <div><strong>${videoCount}</strong> videos</div>
                    <div><strong>${withLocationCount}</strong> with GPS</div>
                </div>
                <p style="margin: 10px 0; color: #666;">
                    üìä Estimated size: ~${estimatedSize} MB
                    ${totalCount > 100 ? '<br>‚ö†Ô∏è Large number of files - loading may take time' : ''}
                </p>
            `;
            
            resultsDiv.style.display = 'block';
            
            // Update map with location data immediately (lightweight)
            updateMapWithResults(results);
        }

        // Load images after user confirms
        async function loadImages() {
            try {
                document.getElementById('loading-images').style.display = 'block';
                document.getElementById('search-results').style.display = 'none';
                
                loadedMediaData = [...searchResults];
                
                // Display the media grid
                displayMedia(loadedMediaData);
                
                document.getElementById('loading-images').style.display = 'none';
                document.getElementById('media-grid').style.display = 'grid';
                
            } catch (error) {
                console.error('Error loading images:', error);
                showError('Failed to load images. Please try again.');
                document.getElementById('loading-images').style.display = 'none';
            }
        }

        // Clear results and start over
        function clearResults() {
            searchResults = [];
            loadedMediaData = [];
            
            document.getElementById('search-results').style.display = 'none';
            document.getElementById('media-grid').style.display = 'none';
            document.getElementById('initial-message').style.display = 'block';
            
            // Clear map markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            // Reset form
            document.getElementById('city-filter').value = '';
            document.getElementById('country-filter').value = '';
            document.getElementById('date-from').value = '';
            document.getElementById('date-to').value = '';
            document.getElementById('has-people').value = '';
            document.getElementById('talking').value = '';
        }

        // Display media in grid
        function displayMedia(data) {
            const grid = document.getElementById('media-grid');
            
            if (data.length === 0) {
                grid.innerHTML = '<div class="loading">No media found matching your filters.</div>';
                return;
            }
            
            grid.innerHTML = data.map(media => {
                const isVideo = media.file_extension && 
                    ['.mp4', '.mov', '.avi', '.mkv', '.webm'].includes(media.file_extension.toLowerCase());
                
                const tags = [];
                if (media.city_en && media.country_en) tags.push(`${media.city_en}, ${media.country_en}`);
                if (media.people_count > 0) tags.push(`${media.people_count} people`);
                if (media.talking_detected) tags.push('Talking');
                if (media.activities && media.activities.length > 0) tags.push(...media.activities);
                if (media.scenery && media.scenery.length > 0) tags.push(...media.scenery);
                
                // Format creation time for display
                let displayTime = formatCreationTime(media.creation_time);
                
                return `
                    <div class="media-card" onclick="openMediaModal(${media.id})">
                        ${isVideo ? 
                            `<video src="/api/media/${media.id}/thumbnail" muted preload="none" 
                                    style="pointer-events: none;"></video>` :
                            `<img src="/api/media/${media.id}/thumbnail" alt="Media" 
                                  loading="lazy"
                                  onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3QgeD0iMyIgeT0iMyIgd2lkdGg9IjE4IiBoZWlnaHQ9IjE4IiByeD0iMiIgc3Ryb2tlPSIjY2NjIiBzdHJva2Utd2lkdGg9IjIiLz4KPGNpcmNsZSBjeD0iOC41IiBjeT0iOC41IiByPSIxLjUiIGZpbGw9IiNjY2MiLz4KPHBhdGggZD0ibTIxIDEyLTUtNUw1IDE4IiBzdHJva2U9IiNjY2MiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+Cjwvc3ZnPgo='">`
                        }
                        <div class="media-card-content">
                            <h3>${media.filename || 'Unknown File'}</h3>
                            <div class="meta">üìÖ ${displayTime}</div>
                            ${media.city_zh && media.country_zh ? `<div class="meta">üìç ${media.city_zh}, ${media.country_zh}</div>` : ''}
                            <div class="tags">
                                ${tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

                // Update map with search results (lightweight - no image loading)
        function updateMapWithResults(data) {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            // Add new markers
            const locations = {};
            data.forEach(media => {
                if (media.latitude && media.longitude) {
                    const key = `${media.latitude},${media.longitude}`;
                    if (!locations[key]) {
                        locations[key] = {
                            lat: media.latitude,
                            lng: media.longitude,
                            city: media.city_zh,
                            country: media.country_zh,
                            count: 0,
                            media: []
                        };
                    }
                    locations[key].count++;
                    locations[key].media.push(media);
                }
            });
            
            Object.values(locations).forEach(location => {
                const marker = L.marker([location.lat, location.lng])
                    .bindPopup(`
                        <div>
                            <h3>${location.city || 'Unknown'}, ${location.country || 'Unknown'}</h3>
                            <p>${location.count} media file(s)</p>
                            <div style="margin-top: 10px;">
                                ${location.media.slice(0, 3).map(media => `
                                    <div style="margin: 5px 0; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                                        <strong>${media.filename}</strong><br>
                                        <small>${formatCreationTime(media.creation_time)}</small><br>
                                        <button onclick="openFileInSystem(${media.id})" style="margin-top: 5px; padding: 3px 8px; background: #667eea; color: white; border: none; border-radius: 3px; cursor: pointer;">
                                            Open File
                                        </button>
                                    </div>
                                `).join('')}
                                ${location.media.length > 3 ? `<p><small>... and ${location.media.length - 3} more</small></p>` : ''}
                            </div>
                            <button onclick="filterByLocation('${location.city}', '${location.country}')" style="margin-top: 10px; padding: 8px 12px; background: #764ba2; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                Filter by this location
                            </button>
                        </div>
                    `)
                    .addTo(map);
                markers.push(marker);
            });
            
            // Fit map to markers if any exist
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        // Filter by location (fill form fields)
        function filterByLocation(city, country) {
            document.getElementById('city-filter').value = city || '';
            document.getElementById('country-filter').value = country || '';
            // Don't auto-search, let user click search button
        }

        // Display media in grid (only called after user confirms loading)
        function displayMedia(data) {
            const grid = document.getElementById('media-grid');
            
            if (data.length === 0) {
                grid.innerHTML = '<div class="loading">No media found matching your search criteria.</div>';
                return;
            }
            
            grid.innerHTML = data.map(media => {
                const isVideo = media.file_extension && 
                    ['.mp4', '.mov', '.avi', '.mkv', '.webm'].includes(media.file_extension.toLowerCase());
                
                const tags = [];
                if (media.city_en && media.country_en) tags.push(`${media.city_en}, ${media.country_en}`);
                if (media.people_count > 0) tags.push(`${media.people_count} people`);
                if (media.talking_detected) tags.push('Talking');
                if (media.activities && media.activities.length > 0) tags.push(...media.activities);
                if (media.scenery && media.scenery.length > 0) tags.push(...media.scenery);
                
                // Format creation time for display
                let displayTime = formatCreationTime(media.creation_time);
                
                return `
                    <div class="media-card" onclick="openMediaModal(${media.id})">
                        ${isVideo ? 
                            `<video src="/api/media/${media.id}/thumbnail" muted preload="none" 
                                    style="pointer-events: none;"></video>` :
                            `<img src="/api/media/${media.id}/thumbnail" alt="Media" 
                                  loading="lazy"
                                  onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3QgeD0iMyIgeT0iMyIgd2lkdGg9IjE4IiBoZWlnaHQ9IjE4IiByeD0iMiIgc3Ryb2tlPSIjY2NjIiBzdHJva2Utd2lkdGg9IjIiLz4KPGNpcmNsZSBjeD0iOC41IiBjeT0iOC41IiByPSIxLjUiIGZpbGw9IiNjY2MiLz4KPHBhdGggZD0ibTIxIDEyLTUtNUw1IDE4IiBzdHJva2U9IiNjY2MiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+Cjwvc3ZnPgo='">`
                        }
                        <div class="media-card-content">
                            <h3>${media.filename || 'Unknown File'}</h3>
                            <div class="meta">üìÖ ${displayTime}</div>
                            ${media.city_zh && media.country_zh ? `<div class="meta">üìç ${media.city_zh}, ${media.country_zh}</div>` : ''}
                            <div class="tags">
                                ${tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Filter by location
        function filterByLocation(city, country) {
            document.getElementById('city-filter').value = city || '';
            document.getElementById('country-filter').value = country || '';
            applyFilters();
        }

        // Open file in system default application
        async function openFileInSystem(mediaId) {
            try {
                const response = await fetch(`/api/media/${mediaId}/open`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    console.log('File opened successfully:', result.message);
                } else {
                    console.error('Error opening file:', result.error);
                    alert('Error opening file: ' + result.error);
                }
            } catch (error) {
                console.error('Error opening file:', error);
                alert('Error opening file: ' + error.message);
            }
        }

        // Apply filters
        function applyFilters() {
            const city = document.getElementById('city-filter').value.toLowerCase();
            const country = document.getElementById('country-filter').value.toLowerCase();
            const dateFrom = document.getElementById('date-from').value;
            const dateTo = document.getElementById('date-to').value;
            const hasPeople = document.getElementById('has-people').value;
            const talking = document.getElementById('talking').value;
            
            filteredData = mediaData.filter(media => {
                if (city && (!media.city_zh || !media.city_zh.toLowerCase().includes(city))) return false;
                if (country && (!media.country_zh || !media.country_zh.toLowerCase().includes(country))) return false;
                
                if (dateFrom || dateTo) {
                    // Convert creation_time to proper date format for comparison
                    let mediaTime = null;
                    if (media.creation_time) {
                        let formattedTime = media.creation_time;
                        if (formattedTime.match && formattedTime.match(/\d{4}-\d{2}-\d{2} \d{2}-\d{2}-\d{2}/)) {
                            formattedTime = formattedTime.replace(/ (\d{2})-(\d{2})-(\d{2})/, ' $1:$2:$3');
                        }
                        mediaTime = new Date(formattedTime);
                    }
                    if (dateFrom && mediaTime && mediaTime < new Date(dateFrom)) return false;
                    if (dateTo && mediaTime && mediaTime > new Date(dateTo)) return false;
                }
                
                if (hasPeople === 'true' && media.people_count <= 0) return false;
                if (hasPeople === 'false' && media.people_count > 0) return false;
                if (talking === 'true' && !media.talking_detected) return false;
                if (talking === 'false' && media.talking_detected) return false;
                
                return true;
            });
            
            displayMedia(filteredData);
            updateMap(filteredData);
        }

        // Open media modal
        async function openMediaModal(mediaId) {
            try {
                const response = await fetch(`/api/media/${mediaId}`);
                const media = await response.json();
                
                const modal = document.getElementById('media-modal');
                const title = document.getElementById('modal-title');
                const body = document.getElementById('modal-body');
                
                title.textContent = `${media.city_zh || 'Unknown Location'} - ${media.filename || 'Unknown File'}`;
                
                const isVideo = media.file_extension && 
                    ['.mp4', '.mov', '.avi', '.mkv', '.webm'].includes(media.file_extension.toLowerCase());
                
                const displayTime = formatCreationTime(media.creation_time);
                
                body.innerHTML = `
                    ${isVideo ? 
                        `<video class="modal-media" controls src="/api/media/${media.id}/file"></video>` :
                        `<img class="modal-media" src="/api/media/${media.id}/file" alt="Media">`
                    }
                    <div>
                        <h3>Details</h3>
                        <p><strong>Filename:</strong> ${media.filename || 'N/A'}</p>
                        <p><strong>Creation Time:</strong> ${displayTime}</p>
                        <p><strong>Location:</strong> ${media.city_zh || 'N/A'}, ${media.country_zh || 'N/A'}</p>
                        ${media.latitude && media.longitude ? `<p><strong>Coordinates:</strong> ${media.latitude}, ${media.longitude}</p>` : ''}
                        <p><strong>People Count:</strong> ${media.people_count || 0}</p>
                        <p><strong>Talking Detected:</strong> ${media.talking_detected ? 'Yes' : 'No'}</p>
                        ${media.activities && media.activities.length > 0 ? `<p><strong>Activities:</strong> ${media.activities.join(', ')}</p>` : ''}
                        ${media.scenery && media.scenery.length > 0 ? `<p><strong>Scenery:</strong> ${media.scenery.join(', ')}</p>` : ''}
                        <p><strong>File Path:</strong> ${media.filepath || 'N/A'}</p>
                        <p><strong>File Size:</strong> ${media.size ? (media.size / 1024 / 1024).toFixed(2) + ' MB' : 'N/A'}</p>
                        <button style="margin-top: 10px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;" onclick="openFileInSystem(${media.id})">
                            üì± Open with System App
                        </button>
                    </div>
                `;
                
                modal.style.display = 'block';
            } catch (error) {
                console.error('Error loading media details:', error);
                showError('Failed to load media details.');
            }
        }

        // Open file in system default application
        async function openFileInSystem(mediaId) {
            try {
                const response = await fetch(`/api/media/${mediaId}/open`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    console.log('File opened successfully:', result.message);
                } else {
                    console.error('Error opening file:', result.error);
                    alert('Error opening file: ' + result.error);
                }
            } catch (error) {
                console.error('Error opening file:', error);
                alert('Error opening file: ' + error.message);
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Filter inputs
            ['city-filter', 'country-filter', 'date-from', 'date-to', 'has-people', 'talking'].forEach(id => {
                document.getElementById(id).addEventListener('input', applyFilters);
                document.getElementById(id).addEventListener('change', applyFilters);
            });
            
            // Modal close
            document.querySelector('.close').addEventListener('click', function() {
                document.getElementById('media-modal').style.display = 'none';
            });
            
            // Close modal when clicking outside
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('media-modal');
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            setupEventListeners();
        });
    </script>
</body>
</html>
